<!DOCTYPE html>

<html>

<head>

<title>Chabunko</title>

<style type=text/css>

html, body
    { padding: 0
    ; margin: 0
    ; font-family: %font
    ; font-size: %size
    ; background: %bg
    ; color: %fg
    }

a { color: %link }

input
    { color: %fg
    ; background: %panelbg
    ; border: none
    ; font-family: %font
    ; font-size: %size
    }

#log
    { padding: 2px
    ; display: table
    ; width: 100%
    ; max-width: 100%
    ; overflow: hidden
    }

#inputform
    { position: fixed
    ; bottom: 0
    ; left: 0
    ; display: block
    ; width: 100%
    }

#input
    { overflow: hidden
    ; display: block
    ; width: 100%
    ; border-top: 1px solid %fg
    }

#input:hover
    { background: %hoverbg }

#self
    { display: block
    ; float: left
    ; background: %panelbg
    ; color: %fg
    ; border-top: 1px solid %fg
    }

#self:hover
    { background: %hoverbg }

.timestamp
    { color: %info }

.nick
    { color: #bb88dd
    ; text-align: right
    ; padding: 0pt 8pt
    ; border-right: 1px solid %fg
    ; max-width: 100pt
    ; text-overflow: ellipsis
    ; overflow: hidden
    }

.botnick:before
    { content: "• " }

.message
    { padding: 0pt 9pt
    ; width: 100%
    }

span.line
    { display: table-row }

span.line:nth-child(odd)
    { background: %oddbg }

span.line:nth-child(even)
    { background: %evenbg }

span.line:hover
    { background: %hoverbg }

span.line > span
    { display: table-cell
    ; white-space: pre
    }

span.line > .message
    { white-space: pre-wrap }

.embed
    { max-height: 64px
    ; max-width: 100%
    ; display: block
    }

.highlight
    { color: %highlight }

#settings
    { width: 100%
    ; height: 100%
    ; top: 0
    ; left: 0
    ; position: fixed
    ; background-color: rgba(0, 0, 0, 0.5)
    ; display: none
    }

#settingsform
    { display: block
    ; width: 80%
    ; height: 80%
    ; margin: 10% auto 0 auto
    ; background: %panelbg
    ; color: %fg
    }

%css
</style>

<script type=text/javascript>

// nick :: String
var nick = "%nick"

// time :: Number
var time = 1000

// colors :: Object String String
var colors =
    { white: "%white", black: "%black", blue: "%blue", green: "%green"
    , red: "%red", darkred: "%darkred", darkmagenta: "%darkmagenta"
    , orange: "%orange" , yellow: "%yellow", lightgreen: "%lightgreen"
    , cyan: "%cyan", lightcyan: "%lightcyan", darkblue: "%darkblue"
    , magenta: "%magenta", gray: "%gray", lightgray: "%lightgray"
    }

// colorints :: Object String String
var colorints =
    { "00": "white", "01": "black", "02": "blue", "03": "green", "04": "red"
    , "05": "darkred", "06": "darkmagenta", "07": "orange", "08": "yellow"
    , "09": "lightgreen", "10": "cyan", "11": "lightcyan", "12": "darkblue"
    , "13": "magenta", "14": "gray", "15": "lightgray"
    }

// flash :: String -> IO ()
function flash(c){
    var inp = document.getElementById("input")

    inp.style.backgroundColor = c
    setTimeout(function(){ inp.style.backgroundColor = "" }, 1000)
    inp.value = ""
}

// submit :: String -> IO ()
function submit(s){
    var xhr = new XMLHttpRequest()
    xhr.timeout = 10800

    var f = function(){
        if (xhr.readyState === 4) {
            if (xhr.status === 200) flash(colors["green"])
            else flash(colors["red"])
        }
    }

    xhr.onreadystatechange = f

    xhr.open("GET", "/irc-send?nick=" + encodeURIComponent(nick) + "&msg="
            + encodeURIComponent(s)
            )

    xhr.send()
}

// | Load new messages. Takes time as a string as the only argument.
// loadNew :: String -> IO ()
function loadNew(time){
    var xhr = new XMLHttpRequest()
    xhr.timeout = 10800

    var f = function(){
        if (xhr.readyState === 4) {
            if (xhr.status === 200) addNew(xhr.responseText)
            else console.warn("Unable to load new messages.")
        }
    }

    xhr.onreadystatechange = f

    xhr.open("GET", "/irc-new?nick=" + encodeURIComponent(nick) + "&time="
            + encodeURIComponent(time) + "&rand="
            + encodeURIComponent((new Date()).getTime())
            )

    xhr.send()
}

// nickColor :: String -> String
function nickColor(name){
    var rcolors = [ colors["blue"], colors["green"], colors["red"]
                  , colors["darkred"], colors["darkmagenta"], colors["orange"]
                  , colors["yellow"], colors["lightgreen"], colors["cyan"]
                  , colors["lightcyan"], colors["darkblue"], colors["magenta"]
                  ]
    var sum = 0

    for(var i = 0; i < name.length; i++) sum += name.charCodeAt(i)

    sum = sum % rcolors.length

    return rcolors[sum]
}

// nickOnly :: String -> String
function nickOnly(name){
    return name.replace(/^[~&@%+]/, "")
}

// embed :: String -> String
function embed(url){
    var la = "<a target=_blank href=" + url + ">"
    var mid = url
    var ra = "</a>"

    if (url.match(/(jpe?g|a?png|gif|bmp)(\?\S+)?$/i))
        mid = "<img class=embed src="
            + url
            + " alt="
            + url
            + ">"

    if (url.match(/youtu(\.be\/|be\.com\/watch\?v=\S+)/i))
        mid = "<img class=embed src=http://img.youtube.com/vi/"
            + url.match(/(youtu\.be\/|v=)(\S{11})/)[2]
            + "/0.jpg alt="
            + url
            + ">"

    return la + mid + ra
}

// pad :: String -> String
function pad(xs){
    return xs.length < 2 ? '0' + xs : xs
}

// Char by Char until regex matches then take until next \u0003
// "\ETX00,00text text\ETX text"
// colorize :: String -> String
function colorize(co){
    var coreg = /^\u0003(?:(1[0-5]|0?\d)(?:,(1[0-5]|0?\d))?)/
    var nest = false
    var acc = ""

    for (var i = 0; i < co.length; i++) {
        var ma = co.substr(i).match(coreg)
        if (ma) {
            if (nest) acc += "</span>"
            var fg = "color:" + colors[colorints[pad(ma[1])]] + ';'
            var bg = ""
            if (ma[2] !== undefined)
                bg = "background-color:" + colors[colorints[pad(ma[2])]] + ';'

            acc += "<span style='" + fg + bg + "'>"

            i += ma[0].length - 1
            nest = true

        } else if (nest && co[i] === '\u0003') {
            acc += "</span>"
            nest = false

        } else acc += co[i]
    }

    if (nest) acc += "</span>"

    console.log("acc: " + acc)

    return acc
}

// stripColor :: String -> String
function stripColor(x){
    return x.replace(/\u0003((1[0-5]|0?\d)(,(1[0-5]|0?\d))?)?/g, "")
}

function action(msg){
    if (msg.match(/^\/me /i))
        msg = msg.replace("/me", "\u000305♥\u0003 "
                               + nick
                               + msg.replace(/^\/me/i, ""))

    return msg
}

// addNew :: String -> IO ()
function addNew(str){
    var lines = str.split('\n').filter(function(x){ return x !== "" })

    // Scroll height before new messages
    var wh = window.scrollY + window.innerHeight
    var bh = document.body.scrollHeight

    for (var i = 0; i < lines.length; i++) {
        var line = document.createElement("span")
        var ts = document.createElement("span")
        var ni = document.createElement("span")
        var ms = document.createElement("span")

        var cells = lines[i].split('\t')
        if (cells.length < 3) continue

        line.className = "line"
        ts.className = "timestamp"
        ni.className = "nick"
        ms.className = "message"

        ts.textContent = cells[0].split('-')[2]
        ts.name = cells[0]
        ni.textContent = cells[1]
        ms.textContent = cells.slice(2).join('\t')

        line.appendChild(ts)
        line.appendChild(ni)
        line.appendChild(ms)

        var log = document.getElementById("log")
        log.appendChild(line)

        prepareLine(line)
    }

    if (lines.length < 1) {
        console.log("Found no new messages!")
        time = Math.min(time * 2, 10800)

    } else {
        console.log("Found " + lines.length + " new messages~")
        time = 1000

        // Scroll
        var log = document.getElementById("log")

        console.log(wh + " >= " + (bh - 20))
        if (wh >= bh - 20) window.scrollBy(0, log.scrollHeight)
    }
}

function prepareLine(line){
    var ts = line.children[0]
    var ni = line.children[1]
    var ms = line.children[2]

    // Display user nick
    if (ni.textContent === "Chabunko") {
        var msp = ms.innerHTML.split(": ")
        ms.innerHTML = msp.slice(1).join(": ")
        ni.textContent = stripColor(msp[0])
        ni.className += " botnick"
    }

    // Nick coloring
    if ("%nick" !== nickOnly(ni.textContent))
        ni.style.color = nickColor(nickOnly(ni.textContent))
    else ni.style.color = "%self"

    // Nick max length
    if (ni.textContent.length > 10)
        ni.textContent = ni.textContent.substr(0, 10) + "…"

    // URLs and embedding
    ms.innerHTML = ms.innerHTML.replace(/https?:\/\/\S+/ig, embed)

    // Coloring
    ms.innerHTML = colorize(ms.innerHTML)

    // Word highlighting
    if (ms.textContent.match(RegExp("(^|\s|[^a-zA-Z])" + nick + "(\s|$|[^a-zA-Z])", 'i'))) {
        console.log("Highlight: " + nick)
        ms.className += " highlight"
    }

    // Actions
    if (ms.innerHTML.match(/^\u0001ACTION/)) {
        var nii = ni.cloneNode()
        nii.className = ""
        ms.innerHTML = ms.innerHTML.replace(/^\u0001ACTION/, nii.outerHTML)
        ni.innerHTML = "<span style=color:" + colors["red"] + ">♥</span>"
    }
}

// main :: IO ()
function main(){
    var iw = document.getElementById("inputform")

    // Form submit hijack!
    iw.addEventListener("submit", function(e){
        e.preventDefault()
        submit(this.getElementsByName("msg")[0].value)
    })

    var inp = document.getElementById("input")

    // Typing outside input will put the chars into the input.
    document.body.addEventListener("keyup", function(e){
        if (e.ctrlKey || e.altKey);
        else if (e.keyCode >= 32 || e.keyCode == 8) {
            e.stopPropagation()
            inp.value += String.fromCharCode(e.keyCode)
            inp.focus()
        }
    })

    // Prevent Firefox from loading the search engine page
    // i HATE you firefox
    document.body.addEventListener("keydown", function(e){
        if (e.ctrlKey && e.keyCode === 75) {
            e.stopPropagation()
            e.preventDefault()
            return false
        }
    })

    // Input keyboard shortcuts
    inp.addEventListener("keyup", function(e){
        e.stopPropagation()
        if (e.keyCode === 13)
            submit(this.value)

        else if (e.ctrlKey && e.keyCode === 75)
            inp.value += '\u0003'
    })

    window.onscroll = function(e){
    }

    var snick = document.getElementById("self")
    snick.style.color = nickColor(snick.value)

    document.getElementById("input").focus()

    loadNew("")
    newLoop()
}

function stime(){
    var ts = document.getElementsByClassName("timestamp")
    return ts[ts.length - 1].name
}

// newLoop :: IO ()
function newLoop(){
    setTimeout(function(){
        var t = stime()
        console.log("Loading from timestamp " + t)
        loadNew(t)

        newLoop()
    }, time)
}

</script>

</head>

<body>

<div id=wrap>

<div id=log></div>

<input>

<form id=inputform method=GET>
    <div id=inputwrap>
        <input type=button class=nick id=self value=%nick>
        <input type=text id=input autocomplete=off name=msg>
        <input type=hidden name=nick value=%nick>
    </div>
</form>

</div>

<div id=settings>

<form id=settingsform method=GET>

    <span class=line>
        <span>Avatar: </span> <input type=text id=settings-avatar name=avatar>
    </span>

</form>

</div>

<script> main() </script>

</body>

</html>

