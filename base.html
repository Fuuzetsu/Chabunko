<!DOCTYPE html>

<html>

<head>

<title>Chabunko</title>

<style type=text/css>

html, body
    { padding: 0
    ; margin: 0
    ; font-family: %font
    ; font-size: %size
    ; background-color: %bg
    ; color: %fg
    }

a { color: %link }

input
    { color: %fg
    ; background-color: %bg
    ; border: none
    ; font-family: %font
    ; font-size: %size
    }

#log
    { padding: 2px
    ; display: table
    ; width: 100%
    ; max-width: 100%
    ; overflow: hidden
    }

#inputform
    { position: fixed
    ; bottom: 0
    ; left: 0
    ; display: block
    ; width: 100%
    }

#input
    { overflow: hidden
    ; display: block
    ; width: 100%
    ; border-top: 1px solid %fg
    }

#input:hover
    { background-color: %hoverbg }

#self
    { display: block
    ; float: left
    ; background-color: %bg
    ; color: %fg
    ; border-top: 1px solid %fg
    }

#self:hover
    { background-color: %hoverbg }

.timestamp
    { color: %info }

.nick
    { color: #bb88dd
    ; text-align: right
    ; padding: 0pt 8pt
    ; border-right: 1px solid %fg
    ; max-width: 100pt
    ; text-overflow: ellipsis
    ; overflow: hidden
    }

.message
    { padding: 0pt 9pt
    ; width: 100%
    }

span.line
    { display: table-row }

span.line:nth-child(odd)
    { background-color: %oddbg }

span.line:nth-child(even)
    { background-color: %evenbg }

span.line:hover
    { background-color: %hoverbg }

span.line > span
    { display: table-cell
    ; white-space: pre
    }

span.line > .message
    { white-space: normal }

.embed
    { max-height: 64px
    ; max-width: 100%
    ; display: block
    }

.highlight
    { color: %highlight }

%css
</style>

<script type=text/javascript>

var nick = "%nick"

var time = 1000

var colors =
    { white: "%white", black: "%black", blue: "%blue", green: "%green"
    , red: "%red", darkred: "%darkred", darkmagenta: "%darkmagenta"
    , orange: "%orange" , yellow: "%yellow", lightgreen: "%lightgreen"
    , cyan: "%cyan", lightcyan: "%lightcyan", darkblue: "%darkblue"
    , magenta: "%magenta", gray: "%gray", lightgray: "%lightgray"
    }

var colorints =
    { "00": "white", "01": "black", "02": "blue", "03": "green", "04": "red"
    , "05": "darkred", "06": "darkmagenta", "07": "orange", "08": "yellow"
    , "09": "lightgreen", "10": "cyan", "11": "lightcyan", "12": "darkblue"
    , "13": "magenta", "14": "gray", "15": "lightgray"
    }

// flash :: String -> IO ()
function flash(c){
    var inp = document.getElementById("input")

    inp.style.backgroundColor = c
    setTimeout(function(){ inp.style.backgroundColor = "" }, 1000)
    inp.value = ""
}

// submit :: String -> IO ()
function submit(s){
    var xhr = new XMLHttpRequest()
    xhr.timeout = 10800

    var f = function(){
        if (xhr.readyState === 4) {
            if (xhr.status === 200) flash("green")
            else flash("red")
        }
    }

    xhr.onreadystatechange = f

    xhr.open("GET", "/irc-send?nick=" + encodeURIComponent(nick) + "&msg="
            + encodeURIComponent(s)
            )

    xhr.send()
}

// | Load new messages. Takes time as a string as the only argument.
// loadNew :: String -> IO ()
function loadNew(time){
    var xhr = new XMLHttpRequest()
    xhr.timeout = 10800

    var f = function(){
        if (xhr.readyState === 4) {
            if (xhr.status === 200) addNew(xhr.responseText)
            else console.warn("Unable to load new messages.")
        }
    }

    xhr.onreadystatechange = f

    xhr.open("GET", "/irc-new?nick=" + encodeURIComponent(nick) + "&time="
            + encodeURIComponent(time) + "&rand="
            + encodeURIComponent((new Date()).getTime())
            )

    xhr.send()
}

// nickColor :: String -> String
function nickColor(name){
    var rcolors = [ colors["blue"], colors["green"], colors["red"]
                  , colors["darkred"], colors["darkmagenta"], colors["orange"]
                  , colors["yellow"], colors["lightgreen"], colors["cyan"]
                  , colors["lightcyan"], colors["darkblue"], colors["magenta"]
                  ]
    var sum = 0

    for(var i = 0; i < name.length; i++) {
        sum += name.charCodeAt(i)
    }

    sum = sum % rcolors.length

    return rcolors[sum]
}

// nickOnly :: String -> String
function nickOnly(name){
    return name.replace(/^[~&@%+]/, "")
}

// embed :: String -> String
function embed(url){
    var la = "<a target=_blank href=" + url + ">"
    var mid = url
    var ra = "</a>"

    if (url.match(/(jpe?g|a?png|gif|bmp)(\?\S+)?$/i))
        mid = "<img class=embed src="
            + url
            + " alt="
            + url
            + ">"

    if (url.match(/youtu(\.be\/|be\.com\/watch\?v=\S+)/i))
        mid = "<img class=embed src=http://img.youtube.com/vi/"
            + url.match(/(youtu\.be\/|v=)(\S{11})/)[2]
            + "/0.jpg alt="
            + url
            + ">"

    return la + mid + ra
}

// pad :: String -> String
function pad(xs){
    return xs.length < 2 ? '0' + xs : xs
}

// colorize :: String -> String
function colorize(co){
    var fg = ""
    var bg = ""

    co = co.replace(/\u0003/g, "")

    if (co.match(",")) {
        fg = colors[colorints[pad(co.split(',')[0])]]
        bg = colors[colorints[pad(co.split(',')[1])]]

    } else fg = colors[colorints[pad(co)]]

    return "<span style=color:" + fg + ";background-color:" + bg + ">"
}

function action(msg){
    if (msg.match(/^\/me /i))
        msg = msg.replace("/me", "\u000305♥\u0003 "
                               + nick
                               + msg.replace(/^\/me/i, ""))

    return msg
}

// addNew :: String -> IO ()
function addNew(html){
    console.log(html)
    if (html.length > 0) {
        var log = document.getElementById("log")
        var ms = log.children
        var olen = ms.length
        log.innerHTML += html
        var nlen = document.getElementById("log").children.length

        console.log("Found " + (nlen - olen) + " new messages~")

        for (var i = olen - 1; i < nlen; i++) prepareLine(ms[i])

        time = 1000

    } else {
        console.log("Found no new messages!")
        time = Math.min(time * 2, 10800)
    }
}

function prepareLine(line){
    var ts = line.children[0]
    var ni = line.children[1]
    var ms = line.children[2]

    // Nick coloring
    if ("%nick" !== nickOnly(ni.textContent))
        ni.style.color = nickColor(nickOnly(ni.textContent))
    else ni.style.color = "%self"

    // Nick max length
    if (ni.textContent.length > 10)
        ni.textContent = ni.textContent.substr(0, 10) + "…"

    // URLs and embedding
    ms.innerHTML = ms.innerHTML.replace(/https?:\/\/\S+/ig, embed)

    // Coloring
    ms.innerHTML = ms.innerHTML.replace(/\u0003([0-1][0-6]|\d)(,([0-1][0-6]|[0-9]))?/g, colorize)

    // XXX only highlight nick?
    // Word highlighting
    if (ms.textContent.match(RegExp(nick, 'i'))) {
        console.log("Highlight: " + nick)
        ms.className += " highlight"
    }

    if (ms.innerHTML.match(/^\u0001ACTION/)) {
        var nii = ni.cloneNode()
        nii.className = ""
        ms.innerHTML = ms.innerHTML.replace(/^\u0001ACTION/, nii.outerHTML)
        ni.innerHTML = "<span style=color:" + colors["red"] + ">♥</span>"
    }
}

// main :: IO ()
function main(){
    var iw = document.getElementById("inputform")
    iw.addEventListener("submit", function(e){
        e.preventDefault()
        submit(this.getElementsByName("msg")[0].value)
    })

    var inp = document.getElementById("input")

    document.body.addEventListener("keyup", function(e){
        if (e.keyCode >= 32 || e.keyCode == 8) {
            e.stopPropagation()
            inp.focus()
            inp.value += String.fromCharCode(e.keyCode)
        }
    })
    inp.addEventListener("keyup", function(e){
        e.stopPropagation()
        if (e.keyCode === 13)
            submit(this.value)
    })

    var snick = document.getElementById("self")
    snick.style.color = nickColor(snick.value)

    var lines = document.getElementsByClassName("line")

    console.log(lines.length + " lines")
    for (var i = 0; i < lines.length; i++) prepareLine(lines[i])

    document.getElementById("input").focus()

    newLoop()
}

// newLoop :: IO ()
function newLoop(){
    setTimeout(function(){
        var ts = document.getElementsByClassName("timestamp")
        var stime = ts[ts.length - 1].textContent
        console.log("Loading from timestamp " + stime)
        loadNew(stime)

        newLoop()
    }, time)
}

</script>

</head>

<body>

<div id=wrap>

<div id=log>
%html
</div>

<input>

<form id=inputform method=POST>
    <div id=inputwrap>
        <input type=button class=nick id=self value=%nick>
        <input type=text id=input name=msg>
        <input type=hidden name=nick value=%nick>
    </div>
</form>

</div>

<script> main() </script>

</body>

</html>

